<!DOCTYPE html>
<meta charset="utf-8">
<pre class="metadata">
title: Intl.Segmenter Proposal
status: proposal
stage: 3
location: https://github.com/tc39/proposal-intl-segmenter
shortname: &lt;a href="https://github.com/tc39/proposal-intl-segmenter"&gt;proposal-intl-segmenter&lt;/a&gt;
copyright: false
contributors: Richard Gibson, Daniel Ehrenberg
</pre>
<emu-biblio href="./biblio.json"></emu-biblio>

<style>
emu-issue {
    margin: 1em 0;
    padding: .5em;
    padding-left: 1em;
    display: block;
}

emu-issue:before {
    display: block;
    padding-bottom: .5em;
    margin-left: -.5em;
}

emu-issue {
    border-left: 5px solid #ff0000;
    background: #ffdddd;
}

emu-issue:before {
    color: #770000;
    content: "ISSUE";
}
</style>


<emu-clause id="segmenter-objects">
  <h1>Segmenter Objects</h1>

  <emu-clause id="sec-intl-segmenter-constructor">
    <h1>The Intl.Segmenter Constructor</h1>

    <p>
      The Segmenter constructor is the <dfn>%Segmenter%</dfn> intrinsic object and a standard built-in property of the Intl object. Behaviour common to all service constructor properties of the Intl object is specified in <emu-xref href="#sec-internal-slots"></emu-xref>.
    </p>

    <emu-clause id="sec-intl.segmenter">
      <h1>Intl.Segmenter ([ _locales_ [ , _options_ ]])</h1>

      <p>
        When the `Intl.Segmenter` function is called with optional arguments _locales_ and _options_, the following steps are taken:
      </p>

      <emu-alg>
        1. If NewTarget is *undefined*, throw a *TypeError* exception.
        1. Let _internalSlotsList_ be &laquo; [[InitializedSegmenter]], [[Locale]], [[SegmenterGranularity]] &raquo;.
        1. Let _segmenter_ be ? OrdinaryCreateFromConstructor(NewTarget, `"%SegmenterPrototype%"`, _internalSlotsList_).
        1. Let _requestedLocales_ be ? CanonicalizeLocaleList(_locales_).
        1. If _options_ is *undefined*, then
          1. Let _options_ be ObjectCreate(*null*).
        1. Else
          1. Let _options_ be ? ToObject(_options_).
        1. Let _opt_ be a new Record.
        1. Let _matcher_ be ? GetOption(_options_, `"localeMatcher"`, `"string"`, &laquo; `"lookup"`, `"best fit"` &raquo;, `"best fit"`).
        1. Set _opt_.[[localeMatcher]] to _matcher_.
        1. Let _localeData_ be %Segmenter%.[[LocaleData]].
        1. Let _r_ be ResolveLocale(%Segmenter%.[[AvailableLocales]], _requestedLocales_, _opt_, %Segmenter%.[[RelevantExtensionKeys]], _localeData_).
        1. Set _segmenter_.[[Locale]] to the value of _r_.[[locale]].
        1. Let _granularity_ be ? GetOption(_options_, `"granularity"`, `"string"`, &laquo; `"grapheme"`, `"word"`, `"sentence"` &raquo;, `"grapheme"`).
        1. Set _segmenter_.[[SegmenterGranularity]] to _granularity_.
        1. Return _segmenter_.
      </emu-alg>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-intl-segmenter-constructor">
    <h1>Properties of the Intl.Segmenter Constructor</h1>

    <p>
      The Intl.Segmenter constructor has the following properties:
    </p>

    <emu-clause id="sec-intl.segmenter.prototype">
      <h1>Intl.Segmenter.prototype</h1>

      <p>
        The value of `Intl.Segmenter.prototype` is %SegmenterPrototype%.
      </p>
      <p>
        This property has the attributes { [[Writable]]: *false*, [[Enumerable]]: *false*, [[Configurable]]: *false* }.
      </p>
    </emu-clause>

    <emu-clause id="sec-intl.segmenter.supportedlocalesof">
      <h1>Intl.Segmenter.supportedLocalesOf ( _locales_ [, _options_ ])</h1>

      <p>
        When the `supportedLocalesOf` method is called with arguments _locales_ and _options_, the following steps are taken:
      </p>

      <emu-alg>
        1. Let _availableLocales_ be %Segmenter%.[[AvailableLocales]].
        1. Let _requestedLocales_ be ? CanonicalizeLocaleList(_locales_).
        1. Return ? SupportedLocales(_availableLocales_, _requestedLocales_, _options_).
      </emu-alg>

      <p>
        The value of the `length` property of the *supportedLocalesOf* method is 1.
      </p>
    </emu-clause>

    <emu-clause id="sec-intl.segmenter-internal-slots">
      <h1>Internal slots</h1>

      <p>
        The value of the [[AvailableLocales]] internal slot is implementation defined within the constraints described in <emu-xref href="#sec-internal-slots"></emu-xref>.
      </p>

      <p>
        The value of the [[LocaleData]] internal slot is implementation defined within the constraints described in <emu-xref href="#sec-internal-slots"></emu-xref>.
      </p>

      <p>
        The value of the [[RelevantExtensionKeys]] internal slot is &laquo; &raquo;.
      </p>

      <emu-note>
        CLDR defines several extension keys, but this specification does not expose them.
      </emu-note>

    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-intl-segmenter-prototype-object">
    <h1>Properties of the Intl.Segmenter Prototype Object</h1>

    <p>
      The Intl.Segmenter prototype object is itself an ordinary object. <dfn>%SegmenterPrototype%</dfn> is not an Intl.Segmenter instance and does not have an [[InitializedSegmenter]] internal slot or any of the other internal slots of Intl.Segmenter instance objects.
    </p>

    <emu-clause id="sec-intl.segmenter.prototype.constructor">
      <h1>Intl.Segmenter.prototype.constructor</h1>

      <p>
        The initial value of `Intl.Segmenter.prototype.constructor` is the intrinsic object %Segmenter%.
      </p>
    </emu-clause>

    <emu-clause id="sec-intl.segmenter.prototype-@@tostringtag">
      <h1>Intl.Segmenter.prototype[ @@toStringTag ]</h1>

      <p>
        The initial value of the @@toStringTag property is the String value `"Object"`.
      </p>
      <p>
        This property has the attributes { [[Writable]]: *false*, [[Enumerable]]: *false*, [[Configurable]]: *true* }.
      </p>
    </emu-clause>

    <emu-clause id="sec-intl.segmenter.prototype.segment">
      <h1>Intl.Segmenter.prototype.segment ( _string_ )</h1>

      <p>
        The `Intl.Segmenter.prototype.segment` method is called on an Intl.Segmenter instance with argument _string_ to create a Segment Iterator over the string using the locale and options of the Intl.Segmenter instance. The following steps are taken:
      </p>

      <emu-alg>
        1. Let _segmenter_ be the *this* value.
        1. Return ? CreateSegmentIterator(_segmenter_, _string_).
      </emu-alg>
    </emu-clause>

    <emu-clause id="sec-intl.segmenter.prototype.resolvedoptions">
      <h1>Intl.Segmenter.prototype.resolvedOptions ()</h1>

      <p>
        This function provides access to the locale and options computed during initialization of the object.
      </p>

      <emu-alg>
        1. Let _segmenter_ be the *this* value.
        1. Perform ? RequireInternalSlot(_segmenter_, [[InitializedSegmenter]]).
        1. Let _options_ be ! ObjectCreate(%ObjectPrototype%).
        1. For each row of <emu-xref href="#table-segmenter-resolvedoptions-properties"></emu-xref>, except the header row, in table order, do
          1. Let _p_ be the Property value of the current row.
          1. Let _v_ be the value of _segmenter_'s internal slot whose name is the Internal Slot value of the current row.
          1. If _v_ is not *undefined*, then
            1. Perform ! CreateDataPropertyOrThrow(_options_, _p_, _v_).
        1. Return _options_.
      </emu-alg>

      <emu-table id="table-segmenter-resolvedoptions-properties">
        <emu-caption>Resolved Options of Segmenter Instances</emu-caption>
        <table class="real-table">
          <thead>
            <tr>
              <th>Internal Slot</th>
              <th>Property</th>
            </tr>
          </thead>
          <tr>
            <td>[[Locale]]</td>
            <td>`"locale"`</td>
          </tr>
          <tr>
            <td>[[SegmenterGranularity]]</td>
            <td>`"granularity"`</td>
          </tr>
        </table>
      </emu-table>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-intl-segmenter-instances">
    <h1>Properties of Intl.Segmenter Instances</h1>

    <p>
      Intl.Segmenter instances are ordinary objects that inherit properties from %SegmenterPrototype%.
    </p>

    <p>
      Intl.Segmenter instances have an [[InitializedSegmenter]] internal slot.
    </p>

    <p>
      Intl.Segmenter instances also have several internal slots that are computed by the constructor:
    </p>

    <ul>
      <li>[[Locale]] is a String value with the language tag of the locale whose localization is used for segmentation.</li>
      <li>[[SegmenterGranularity]] is one of the String values `"grapheme"`, `"word"`, or `"sentence"`, identifying the kind of text element to segment.</li>
    </ul>

  </emu-clause>

  <emu-clause id="sec-segment-iterator-objects">
    <h1>Segment Iterator Objects</h1>

    <p>
      A Segment Iterator is an object that represents a particular iteration over the segments of a specific string.
    </p>

    <emu-clause id="sec-createsegmentiterator" aoid="CreateSegmentIterator">
      <h1>CreateSegmentIterator ( _segmenter_, _string_ )</h1>
      <p>The CreateSegmentIterator abstract operation is called with arguments _segmenter_ (which must be an Intl.Segmenter instance) and _string_ to create a Segment Iterator over the string using the locale and options of the Intl.Segmenter instance. The following steps are taken:</p>
      <emu-alg>
        1. Perform ? RequireInternalSlot(_segmenter_, [[InitializedSegmenter]]).
        1. Let _string_ be ? ToString(_string_).
        1. Let _internalSlotsList_ be &laquo; [[IteratingSegmenter]], [[IteratedString]], [[CurrentSegment]], [[CurrentSegmentCodeUnitIndex]], [[CurrentSegmentIsWordLike]] &raquo;.
        1. Set _iterator_ to ObjectCreate(%SegmentIteratorPrototype%, _internalSlotsList_).
        1. Set _iterator_.[[IteratingSegmenter]] to _segmenter_.
        1. Set _iterator_.[[IteratedString]] to _string_.
        1. Set _iterator_.[[CurrentSegment]] to *null*.
        1. Set _iterator_.[[CurrentSegmentCodeUnitIndex]] to -1.
        1. If _segmenter_.[[SegmenterGranularity]] is `"word"`, then
          1. Set _iterator_.[[CurrentSegmentIsWordLike]] to *null*.
        1. Else
          1. Set _iterator_.[[CurrentSegmentIsWordLike]] to *undefined*.
        1. Return _iterator_.
      </emu-alg>
    </emu-clause>

    <emu-clause id="sec-advancesegmentiterator" aoid="AdvanceSegmentIterator">
      <h1>AdvanceSegmentIterator ( _iterator_, _lastIndex_, _direction_ )</h1>
      <p>The AdvanceSegmentIterator abstract operation is called with arguments _iterator_ (which must be an Intl.Segmenter instance), _lastIndex_ (which must be an integer), and _direction_ (which must be ~forwards~ or ~backwards~) to seek from _lastIndex_ (exclusive) in the specified direction for the start of a segment according to the locale and options of _iterator_'s constructing Intl.Segmenter instance, updating its internal slots to describe the new segment and returning a Boolean value indicating whether its state has changed. The following steps are taken:</p>
      <emu-note>Boundary determination is implementation-dependent, but general default algorithms are specified in Unicode Standard Annex 29 (available at <a href="https://www.unicode.org/reports/tr29/">https://www.unicode.org/reports/tr29/</a>). It is recommended that implementations use locale-sensitive tailorings such as those provided by the Common Locale Data Repository (available at <a href="http://cldr.unicode.org">http://cldr.unicode.org</a>).</emu-note>
      <emu-alg>
        1. Assert: Type(_iterator_) is Object and _iterator_ has an [[IteratingSegmenter]] internal slot.
        1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
        1. Let _segmenter_ be _iterator_.[[IteratingSegmenter]].
        1. Let _locale_ be _segmenter_.[[Locale]].
        1. Let _granularity_ be _segmenter_.[[SegmenterGranularity]].
        1. Let _string_ be _iterator_.[[IteratedString]].
        1. Let _len_ be the length of _string_.
        1. If _direction_ is ~forwards~, then
          1. If _lastIndex_ &ge; _len_, return *false*.
          1. If _lastIndex_ &lt; 0, then
            1. Let _segmentStartIndex_ = 0.
          1. Else
            1. Search _string_ for the first segmentation boundary that follows the code unit at index _lastIndex_, using locale _locale_ and text element granularity _granularity_.
            1. If a boundary is found, let _segmentStartIndex_ be the count of code units in _string_ preceding it. Otherwise, let _segmentStartIndex_ be _len_.
          1. If _segmentStartIndex_ = _len_, then
            1. Set _iterator_.[[CurrentSegmentCodeUnitIndex]] to _len_.
            1. Set _iterator_.[[CurrentSegment]] to *null*.
            1. If _granularity_ is `"word"`, set _iterator_.[[CurrentSegmentIsWordLike]] to *null*.
            1. Return *true*.
        1. Else
          1. Assert: _direction_ is ~backwards~.
          1. If _lastIndex_ &lt; 0, return *false*.
          1. If _len_ is 0 or _lastIndex_ &gt; _len_, set _lastIndex_ to _len_.
          1. If _lastIndex_ &lt; 1,
            1. Set _iterator_.[[CurrentSegmentCodeUnitIndex]] to -1.
            1. Set _iterator_.[[CurrentSegment]] to *null*.
            1. If _granularity_ is `"word"`, set _iterator_.[[CurrentSegmentIsWordLike]] to *null*.
            1. Return *true*.
          1. Search _string_ for the last segmentation boundary that follows fewer than _lastIndex_ code units from the beginning, using locale _locale_ and text element granularity _granularity_.
          1. If a boundary is found, let _segmentStartIndex_ be the count of code units in _string_ preceding it. Otherwise, let _segmentStartIndex_ be 0.
        1. Assert: 0 &le; _segmentStartIndex_ &lt; _len_.
        1. Let _segmentEndIndex_ be the count of code units in _string_ preceding the first segmentation boundary that follows the code unit at index _segmentStartIndex_, using locale _locale_ and text element granularity _granularity_. If no such boundary is found, let _segmentEndIndex_ be _len_.
        1. Assert: _segmentEndIndex_ &gt; _segmentStartIndex_.
        1. Set _iterator_.[[CurrentSegmentCodeUnitIndex]] to _segmentStartIndex_.
        1. Set _iterator_.[[CurrentSegment]] to the String value containing consecutive code units from _string_ beginning with the code unit at index _segmentStartIndex_ and ending with the code unit at index _segmentEndIndex_ - 1.
        1. If _granularity_ is `"word"`, set _iterator_.[[CurrentSegmentIsWordLike]] to a Boolean value indicating whether the word segment in string terminated after _segmentEndIndex_ code units from the beginning is "word-like" according to locale _locale_.
        1. Return *true*.
      </emu-alg>
    </emu-clause>

    <emu-clause id="sec-%segmentiteratorprototype%-object">
      <h1>The %SegmentIteratorPrototype% Object</h1>
      The <dfn>%SegmentIteratorPrototype%</dfn> object:
      <ul>
        <li>is the prototype of all segment iterators.</li>
        <li>is an ordinary object.</li>
        <li>has a [[Prototype]] internal slot whose value is the intrinsic object %IteratorPrototype%.</li>
        <li>has the following properties:
      </ul>
      <emu-clause id="sec-%segmentiteratorprototype%.next">
        <h1>%SegmentIteratorPrototype%.next ()</h1>
        <p>The `next` method is called on a Segment Iterator instance to advance it forward one segment and return an <i>IteratorResult</i> object either describing the new segment or declaring iteration done. The following steps are taken:</p>
        <emu-alg>
          1. Let _iterator_ be *this* value.
          1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
          1. Let _lastIndex_ be _iterator_.[[CurrentSegmentCodeUnitIndex]].
          1. If ! AdvanceSegmentIterator(_iterator_, _lastIndex_, ~forwards~) is *false*, then
            1. Return CreateIterResultObject(*undefined*, *true*).
          1. If Type(_iterator_.[[CurrentSegment]]) is not String, then
            1. Return CreateIterResultObject(*undefined*, *true*).
          1. Let _result_ be ! ObjectCreate(%ObjectPrototype%).
          1. Perform ! CreateDataPropertyOrThrow(_result_, *"segment"*, _iterator_.[[CurrentSegment]]).
          1. Perform ! CreateDataPropertyOrThrow(_result_, *"index"*, _iterator_.[[CurrentSegmentCodeUnitIndex]]).
          1. Perform ! CreateDataPropertyOrThrow(_result_, *"isWordLike"*, _iterator_.[[CurrentSegmentIsWordLike]]).
          1. Return CreateIterResultObject(_result_, *false*).
        </emu-alg>
      </emu-clause>

      <emu-clause id="sec-%segmentiteratorprototype%.following">
        <h1>%SegmentIteratorPrototype%.following( [ _startAfter_ ] )</h1>
        <p>The `following` method is called on a Segment Iterator instance with optional argument _startAfter_ to advance it forward to the first segment starting after that code unit index (when not *undefined*, otherwise after the starting index of the current segment) and return the iterator (or throw, if the start index was out of bounds). The following steps are taken:</p>
        <emu-alg>
          1. Let _iterator_ be *this* value.
          1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
          1. If _startAfter_ is *undefined*, then
            1. Let _lastIndex_ be _iterator_.[[CurrentSegmentCodeUnitIndex]].
          1. Else
            1. Let _lastIndex_ be ? ToNumber(_startAfter_).
            1. If _lastIndex_ is *NaN*, throw a *RangeError* exception.
            1. Set _lastIndex_ to ! ToInteger(_lastIndex_).
          1. If ! AdvanceSegmentIterator(_iterator_, _lastIndex_, ~forwards~) is *false*, throw a *RangeError* exception.
          1. Return _iterator_.
        </emu-alg>
      </emu-clause>

      <emu-clause id="sec-%segmentiteratorprototype%.preceding">
        <h1>%SegmentIteratorPrototype%.preceding( [ _startBefore_ ] )</h1>
        <p>The `preceding` method is called on a Segment Iterator instance with optional argument _startBefore_ to advance it backward to the first segment starting before that code unit index (when not *undefined*, otherwise before the starting index of the current segment) and return the iterator (or throw, if the start index was out of bounds). The following steps are taken:</p>
        <emu-alg>
          1. Let _iterator_ be *this* value.
          1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
          1. If _startBefore_ is *undefined*, then
            1. Let _lastIndex_ be _iterator_.[[CurrentSegmentCodeUnitIndex]].
          1. Else
            1. Let _lastIndex_ be ? ToNumber(_startBefore_).
            1. If _lastIndex_ is *NaN*, throw a *RangeError* exception.
            1. Set _lastIndex_ to ! ToInteger(_lastIndex_).
          1. If ! AdvanceSegmentIterator(_iterator_, _lastIndex_, ~backwards~) is *false*, throw a *RangeError* exception.
          1. Return _iterator_.
        </emu-alg>
      </emu-clause>

      <emu-clause id="sec-%segmentiteratorprototype%.segment">
        <h1>get %SegmentIteratorPrototype%.segment</h1>
        <emu-alg>
          1. Let _iterator_ be *this* value.
          1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
          1. Return _iterator_.[[CurrentSegment]].
        </emu-alg>
      </emu-clause>

      <emu-clause id="sec-%segmentiteratorprototype%.index">
        <h1>get %SegmentIteratorPrototype%.index</h1>
        <emu-alg>
          1. Let _iterator_ be *this* value.
          1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
          1. Return _iterator_.[[CurrentSegmentCodeUnitIndex]].
        </emu-alg>
      </emu-clause>

      <emu-clause id="sec-%segmentiteratorprototype%.isWordLike">
        <h1>get %SegmentIteratorPrototype%.isWordLike</h1>
        <emu-alg>
          1. Let _iterator_ be *this* value.
          1. Perform ? RequireInternalSlot(_iterator_, [[IteratingSegmenter]]).
          1. Return _iterator_.[[CurrentSegmentIsWordLike]].
        </emu-alg>
      </emu-clause>
    </emu-clause>

    <emu-clause id="sec-properties-of-segment-iterator-instances">
      <h1>Properties of Segment Iterator Instances</h1>
      <p>Segment Iterator instances are ordinary objects that inherit properties from %SegmentIteratorPrototype%. Segment Iterator instances are initially created with the internal slots described in <emu-xref href="#table-segment-iterator-instance-slots"></emu-xref>.</p>
      <emu-table id="table-segment-iterator-instance-slots">
        <emu-caption>Internal Slots of Segment Iterator Instances</emu-caption>
        <table class="real-table">
          <thead>
            <tr>
              <th>Internal Slot</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>[[IteratingSegmenter]]</td>
              <td>The Intl.Segmenter instance used for iteration.</td>
            </tr>
            <tr>
              <td>[[IteratedString]]</td>
              <td>The String value being iterated upon.</td>
            </tr>
            <tr>
              <td>[[CurrentSegment]]</td>
              <td>The String value of the current segment.</td>
            </tr>
            <tr>
              <td>[[CurrentSegmentCodeUnitIndex]]</td>
              <td>The code unit index in the String value being iterated upon at the start of the current segment.</td>
            </tr>
            <tr>
              <td>[[CurrentSegmentIsWordLike]]</td>
              <td>A Boolean value indicating whether the current segment is "word-like" according to the locale and options of the segmenter instance used for iteration.</td>
            </tr>
          </tbody>
        </table>
      </emu-table>
    </emu-clause>
  </emu-clause>
</emu-clause>
